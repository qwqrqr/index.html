<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, query, orderBy,
  onSnapshot, serverTimestamp, updateDoc, doc, increment
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey : "Ğ¢Ğ’ĞĞ™_API_KEY",
  authDomain : "Ğ¢Ğ’ĞĞ™_AUTH_DOMAIN",
  projectId : "Ğ¢Ğ’ĞĞ™_PROJECT_ID",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

window.processLike = async (id) => {
  const docRef = doc(db, "requests", id);
  await updateDoc(docRef, { likes: increment(1) });
};

document.getElementById('mainBtn').onclick = async () => {
  const btn = document.getElementById('mainBtn');
  const name = document.getElementById('name').value.trim();
  const email = document.getElementById('email').value.trim();

  if (!name || !email) {
    alert("Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸ Ğ²ÑĞµ Ğ¿Ğ¾Ğ»Ñ");
    return;
  }

  btn.disabled = true;

  try {
    await addDoc(collection(db, "requests"), {
      name: name,
      email: email,
      likes: 0,
      timestamp: serverTimestamp()
    });

    document.getElementById('name').value = "";
    document.getElementById('email').value = "";

  } catch (e) {
    console.error(e);
    alert("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸");
  }

  btn.disabled = false;
};

const q = query(collection(db, "requests"), orderBy("timestamp", "desc"));

onSnapshot(q, (snapshot) => {
  const feed = document.getElementById('feed');
  feed.innerHTML = "";

  snapshot.forEach((docItem) => {
    const data = docItem.data();

    const time = data.timestamp
      ? data.timestamp.toDate().toLocaleTimeString()
      : "...";

    feed.innerHTML += `
      <div class="post">
        <span class="time">${time}</span>
        <b>${data.name}</b>
        <p>${data.email}</p>
        <button class="like-btn" onclick="processLike('${docItem.id}')">
          ğŸ‘ ${data.likes || 0}
        </button>
      </div>
    `;
  });
});
</script>
