<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, query, orderBy,
  onSnapshot, serverTimestamp, updateDoc, doc, increment, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

const firebaseConfig = {
   apiKey: "AIzaSyBRCDe11V_kzV_NgjnMQODjBSbt2HPEcw0",
  authDomain: "project-6310900192150801067.firebaseapp.com",
  projectId: "project-6310900192150801067",
  storageBucket: "project-6310900192150801067.firebasestorage.app",
  messagingSenderId: "972562018918",
  appId: "1:972562018918:web:65aa4b40ed4c938970b3a7",
  measurementId: "G-R3ZT2VCSPV"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ»Ğ°Ğ¹ĞºĞ¸ Ñƒ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸
window.processLike = async (id) => {
  const docRef = doc(db, "requests", id);
  await updateDoc(docRef, { likes: increment(1) });
};

// Ğ£Ğ´Ğ°Ğ»ÑĞµÑ‚ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ¿Ğ¾ ID
window.deleteRequest = async (id) => {
  if (!confirm("Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ?")) return;
  const docRef = doc(db, "requests", id);
  await deleteDoc(docRef);
};

// ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ email Ñƒ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸
window.updateEmail = async (id, newEmail) => {
  if (!newEmail.trim()) {
    alert("Email Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼");
    return;
  }
  const docRef = doc(db, "requests", id);
  await updateDoc(docRef, { email: newEmail });
};

// Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸
document.getElementById('mainBtn').onclick = async () => {
  const btn = document.getElementById('mainBtn');
  const name = document.getElementById('name').value.trim();
  const email = document.getElementById('email').value.trim();

  if (!name || !email) {
    alert("Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸ Ğ²ÑĞµ Ğ¿Ğ¾Ğ»Ñ");
    return;
  }

  btn.disabled = true;

  try {
    await addDoc(collection(db, "requests"), {
      name: name,
      email: email,
      likes: 0,
      timestamp: serverTimestamp()
    });

    document.getElementById('name').value = "";
    document.getElementById('email').value = "";

  } catch (e) {
    console.error(e);
    alert("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸");
  }

  btn.disabled = false;
};

// Ğ’Ñ‹Ğ²Ğ¾Ğ´ ÑĞ¿Ğ¸ÑĞºĞ° Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹
const q = query(collection(db, "requests"), orderBy("timestamp", "desc"));

onSnapshot(q, (snapshot) => {
  const feed = document.getElementById('feed');
  feed.innerHTML = "";

  snapshot.forEach((docItem) => {
    const data = docItem.data();

    const time = data.timestamp
      ? data.timestamp.toDate().toLocaleTimeString()
      : "...";

    feed.innerHTML += `
      <div class="post">
        <span class="time">${time}</span>
        <b>${data.name}</b>
        <p>${data.email}</p>
        <button class="like-btn" onclick="processLike('${docItem.id}')">
          ğŸ‘ ${data.likes || 0}
        </button>
        <button class="delete-btn" onclick="deleteRequest('${docItem.id}')">
          ğŸ—‘ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ
        </button>
        <button class="update-btn" onclick="updateEmail('${docItem.id}', prompt('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ email:', '${data.email}'))">
          âœï¸ ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ email
        </button>
      </div>
    `;
  });
});
</script>
